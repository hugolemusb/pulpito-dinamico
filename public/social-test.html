<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Auth Test - Pulpito Din치mico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans p-8">

    <div class="max-w-2xl mx-auto space-y-8 animate-fade-in">
        <div class="text-center space-y-2">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                Prueba de Integraci칩n Social
            </h1>
            <p class="text-gray-400">Pulpito Din치mico - M칩dulo de Streaming</p>
        </div>

        <!-- Status Card -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl">
            <h2 class="text-xl font-semibold mb-4 text-blue-300">Estado de Conexi칩n</h2>
            <div id="status-container" class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">鮫쮪잺</span>
                        <span>Meta (FB/IG)</span>
                    </div>
                    <span id="status-meta" class="px-3 py-1 bg-red-500/20 text-red-400 text-xs rounded-full font-mono">DISCONNECTED</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">游꿧</span>
                        <span>TikTok Live</span>
                    </div>
                    <span id="status-tiktok" class="px-3 py-1 bg-red-500/20 text-red-400 text-xs rounded-full font-mono">DISCONNECTED</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">游니</span>
                        <span>Restream.io</span>
                    </div>
                    <span id="status-restream" class="px-3 py-1 bg-red-500/20 text-red-400 text-xs rounded-full font-mono">DISCONNECTED</span>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="startAuth('meta')" class="p-4 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold transition-all hover:scale-105 active:scale-95 shadow-lg shadow-blue-900/20 flex flex-col items-center gap-2">
                <span>Conectar Meta</span>
                <span class="text-xs font-normal opacity-70">Oauth PKCE Flow</span>
            </button> <!-- Fixed closing tag -->
            <button onclick="startAuth('tiktok')" class="p-4 bg-black border border-gray-700 hover:border-gray-500 rounded-xl font-bold transition-all hover:scale-105 active:scale-95 shadow-lg flex flex-col items-center gap-2">
                <span>Conectar TikTok</span>
                 <span class="text-xs font-normal opacity-70">Login Kit</span>
            </button>
            <button onclick="startAuth('restream')" class="p-4 bg-orange-600 hover:bg-orange-700 rounded-xl font-bold transition-all hover:scale-105 active:scale-95 shadow-lg shadow-orange-900/20 flex flex-col items-center gap-2">
                <span>Conectar Restream</span>
                 <span class="text-xs font-normal opacity-70">Stream Scope</span>
            </button>
        </div>

        <!-- Logs -->
        <div class="bg-black rounded-xl p-4 border border-gray-800 font-mono text-xs h-64 overflow-y-auto" id="logs">
            <div class="text-gray-500 border-b border-gray-800 pb-2 mb-2">System Logs...</div>
        </div>
    </div>

    <script>
        const LOGS = document.getElementById('logs');
        
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            const time = new Date().toISOString().split('T')[1].split('.')[0];
            div.innerHTML = `<span class="text-gray-500">[${time}]</span> <span class="${type === 'error' ? 'text-red-400' : 'text-green-400'}">${msg}</span>`;
            LOGS.appendChild(div);
            LOGS.scrollTop = LOGS.scrollHeight;
        }

        // --- Mocking PKCE & OAuth ---
        
        async function generatePKCE() {
            // In real generation we use crypto.subtle
            log("Generating PKCE Verifier & Challenge...", "info");
            return {
                verifier: "mock_verifier_" + Math.random().toString(36).substring(7),
                challenge: "mock_challenge_" + Math.random().toString(36).substring(7)
            };
        }

        async function startAuth(platform) {
            log(`Starting Auth Flow for: ${platform.toUpperCase()}`);
            
            try {
                const pkce = await generatePKCE();
                log(`PKCE Generated. Challenge: ${pkce.challenge}`);

                // Simulate Popup
                log("Opening Popup...");
                
                // MOCK DELAY
                setTimeout(() => {
                    const success = confirm(`[MOCK POPUP]\n\nDo you want to authorize Pulpito Din치mico to access your ${platform} account?\n\nScopes: public_profile, stream_live`);
                    
                    if (success) {
                        handleCallback(platform, "mock_auth_code_" + Date.now());
                    } else {
                        log("User denied access.", "error");
                    }
                }, 1000);

            } catch (e) {
                log("Error in flow: " + e.message, "error");
            }
        }

        async function handleCallback(platform, code) {
            log(`Callback received! Code: ${code}`);
            log("Exchanging code for Token...");
            
            // Mock Exchange
            setTimeout(() => {
                const token = "access_token_" + Math.random().toString(36).substring(2);
                log(`Token Received: ${token.substring(0, 10)}...`);
                log("Encrypting & Storing...");
                
                updateStatus(platform, true);
                saveToDB(platform, token);
            }, 1000);
        }

        function updateStatus(platform, connected) {
            const el = document.getElementById(`status-${platform}`);
            if (connected) {
                el.className = "px-3 py-1 bg-green-500/20 text-green-400 text-xs rounded-full font-mono";
                el.innerText = "CONNECTED";
            } else {
                el.className = "px-3 py-1 bg-red-500/20 text-red-400 text-xs rounded-full font-mono";
                el.innerText = "DISCONNECTED";
            }
        }

        function saveToDB(platform, token) {
            log(`[DB] Successfully saved encrypted token for ${platform} linked to User ID 1`);
        }

        // Init
        log("System Ready. Waiting for user interaction.");
    </script>
</body>
</html>
